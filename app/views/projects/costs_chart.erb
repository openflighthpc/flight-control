<div class="chart">
  <div class="d-flex justify-content-between">
    <h3 class="chart-title"> Costs Breakdown </h3>
  </div>
  <canvas id="costBreakdownChart"></canvas>
  <script type="text/javascript">
    let costs = <%= @cost_breakdown.to_json %>;
    let actual_breakdown_data = [
      {
        label: 'remaining budget',
        data: costs['actual']['remaining budget'],
        borderColor: 'rgba(120, 63, 191, 0.8)',
        backgroundColor: 'rgba(120, 63, 191, 0.8)',
        type: 'line',
        fill: false,
        cubicInterpolationMode: 'monotone',
        },
        <% @cost_breakdown[:actual][:compute_groups].keys.each do |group| %>
          {
            label: "<%= group %>",
            data: costs['actual']['compute_groups']['<%= group.to_s %>'],
            backgroundColor: '#<%= @project.compute_groups[group.to_s]["colour"] %>',
            stack: 'bars',
          },
        <% end %>
        {
          label: 'core',
          data: costs['actual']['core'],
          backgroundColor: 'rgb(14, 163, 27)',
          borderColor: 'rgb(8, 109, 17)',
          stack: 'bars',
        },
        {
          label: 'core storage',
          data: costs['actual']['core_storage'],
          backgroundColor: 'rgb(255, 172, 0)',
          borderColor: 'rgb(255, 180, 29)',
          stack: 'bars',
        },
        {
          label: 'data out',
          data: costs['actual']['data out'],
          backgroundColor: 'rgb(244, 215, 87)',
          borderColor: 'rgb(241, 204, 39)',
          stack: 'bars',
        },
        {
          label: 'other',
          data: costs['actual']['other'],
          backgroundColor: 'rgb(61, 205, 200)',
          borderColor: 'rgb(12, 192, 186)',
          stack: 'bars',
        },
      ]
    let forecast_breakdown_data = [
      {
        label: 'forecast remaining budget',
          data: costs['forecast']['remaining budget'],
          borderColor: 'rgba(120, 63, 191, 0.4)',
          backgroundColor: 'rgba(120, 63, 191, 0.4)',
          type: 'line',
          fill: false,
          cubicInterpolationMode: 'monotone',
          borderDash: [1, 1]
        },
        <% @cost_breakdown['forecast'][:compute_groups].keys.each do |group| %>
          {
            label: '<%= "forecast #{group}" %>',
            data: costs['forecast']['compute_groups']['<%= group %>'],
            backgroundColor: '<%= Project.lighten_colour("##{@project.compute_groups[group.to_s]["colour"]}") %>',
            stack: 'bars',
          },
        <% end %>
        {
          label: 'forecast core',
          data: costs['forecast']['core'],
          backgroundColor: 'rgb(148, 206, 153)',
          borderColor: 'rgb(148, 206, 153)',
          stack: 'bars',
        },
        {
          label: 'forecast core storage',
          data: costs['forecast']['core_storage'],
          backgroundColor: 'rgb(255, 200, 84)',
          borderColor: 'rgb(255, 200, 84)',
          stack: 'bars',
        },
        {
          label: 'forecast data out',
          data: costs['forecast']['data out'],
          backgroundColor: 'rgb(249, 235, 169)',
          borderColor: 'rgb(249, 235, 169)',
          stack: 'bars',
        },
        {
          label: 'forecast other',
          data: costs['forecast']['other'],
          backgroundColor: 'rgb(158, 230, 227)',
          borderColor: 'rgb(158, 230, 227)',
          stack: 'bars',
        }
      ]
    let ctx = document.getElementById('costBreakdownChart').getContext('2d');
    let costs_chart = null;
    costs_chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: costs.dates,
        datasets: [
        <% if @cost_breakdown[:actual][:any] %>
          actual_breakdown_data,
        <%end%>
        <% if @cost_breakdown['forecast'][:any] %>
          forecast_breakdown_data,
        <%end%>
        ].flat()
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        title: {
          display: true,
          text: 'Select a dataset in the legend to toggle visibility',
          padding: 0
        },legend: {
          labels: {
            filter: function(item, data) {
              return !(item.text.includes('forecast') && forecastAndActual());
            }
          },
          onClick: hideRelatedDatasetOnClick
        },
        tooltips: {
          mode: 'index',
          position: 'nearest',
          filter: function(tooltipItem, data) {
              return !(data.datasets[tooltipItem.datasetIndex].label.includes('forecast') && tooltipItem.index === overlapDateIndex()) && tooltipItem.value != "NaN"
          },
          callbacks: {
            footer: function(tooltipItem, data) {
              let text = nodes[tooltipItem[0].index];
              if (text != null) {
                return `Nodes: ${text}`;
              }
            }
          }
        },
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Date'
            },
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Compute Units'
            },
          }],
        }
      }
    });
    let currentCycleCosts = jQuery.extend(true, {}, costs_chart.data);
  </script>
</div>
